#!/bin/bash

CURRENT_TAG=$(git describe --abbrev=0 --tags)
APP_NAME="msa_sdk"
PRODUCT_VERSION=${CURRENT_TAG#*R}
MAIN_VERSION=${PRODUCT_VERSION%-*}
VERSION=${CURRENT_TAG##*-}
RELEASE=$(date +%Y%m%d%H%M)

sed -e "s/{VERSION}/${VERSION}/"\
    -e "s/{APP_NAME}/${APP_NAME}-${MAIN_VERSION//-/.}/" \
    setup.py.template > setup.py

RPM_HOME="/home/rpm"

pdoc3 --html --force -o msa_sdk/html msa_sdk

mkdir -p rpms/
docker run --rm -u rpm -v "$(pwd):${RPM_HOME}/build" \
    -w "${RPM_HOME}/build" rpm-build \
    python3 setup.py bdist_rpm --release="${RELEASE}" \
    --binary-only \
    --dist-dir rpms/

# clean
rm -rf build/ dist/ "${APP_NAME}_${MAIN_VERSION//-/.}.egg-info"
