#!/bin/bash

CURRENT_TAG=$(git describe --abbrev=0 --tags)
APP_NAME="msa_sdk"
VERSION_MIN=${CURRENT_TAG##*-}
RELEASE=${VERSION_MIN}_$(date +%Y%m%d%H%M)

cp setup.cfg.template setup.cfg

RPM_HOME="/home/rpm"
DOC_DIR="msa_sdk/html"

pdoc3 --html --force -o "${DOC_DIR}" msa_sdk

mkdir -p rpms/
docker run --rm -u rpm -v "$(pwd):${RPM_HOME}/build" \
    -w "${RPM_HOME}/build" rpm-build \
    python3 setup.py bdist_rpm --release="${RELEASE}" \
    --binary-only \
    --dist-dir rpms/

# clean
rm -rf build/ dist/ "${APP_NAME}.egg-info"
rm -rf "${DOC_DIR}"
rm setup.cfg
